// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// PARTNERS
// ============================================

model Partner {
  id               String   @id @default(cuid())
  email            String   @unique
  password         String
  companyName      String
  contactName      String
  phone            String?
  country          String
  website          String?
  address          String?

  // Status: PENDING, ACTIVE, REJECTED, SUSPENDED
  status           String   @default("PENDING")

  // Partner Category: AGENCY_PARTNER, TECH_PARTNER, REFERRAL, CUSTOM
  partnerCategory  String   @default("REFERRAL")

  // Default commission rate for this partner (0.0 - 100.0)
  commissionRate   Float    @default(0.0)

  // Role: always PARTNER_OWNER for Partner model
  role             String   @default("PARTNER_OWNER")

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  approvedAt       DateTime?

  // Contract URL (uploaded by admin)
  contractUrl      String?

  // Omniwallet Account URL (uploaded by admin)
  omniwalletAccountUrl String?

  // Yearly event completion (webinar/joint event)
  hasCompletedYearlyEvent Boolean @default(false)

  // Certification
  isCertified      Boolean  @default(false)
  certifiedAt      DateTime?
  certificationExpiresAt DateTime?  // Fecha de expiración de la certificación
  partnerLandingUrl String?  // URL de la landing del partner en Omniwallet

  // Sistema de Afiliados
  canHaveAffiliates    Boolean  @default(false)  // El admin puede habilitar esto
  parentPartnerId      String?                    // Si es afiliado, referencia al partner padre
  parentPartner        Partner? @relation("PartnerAffiliates", fields: [parentPartnerId], references: [id])
  affiliates           Partner[] @relation("PartnerAffiliates")
  affiliateCommission  Float?                     // Comisión del afiliado (asignada por el padre)
  temporaryPassword    String?                    // Contraseña temporal para afiliados (se borra tras primer login)

  // Relaciones
  users                 User[]
  leads                 Lead[]
  invoices              Invoice[]
  notifications         Notification[]
  certificationAttempts CertificationAttempt[]

  @@map("partners")
}

// ============================================
// USERS (Multi-usuario por partner)
// ============================================

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  name        String

  // Role: ADMIN, PARTNER_OWNER, PARTNER_USER
  role        String

  partnerId   String?
  partner     Partner? @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?

  // Relaciones
  leadsCreated     Lead[]
  leadNotes        LeadNote[]
  notifications    Notification[]
  contentViews     ContentView[]
  contentFavorites ContentFavorite[]

  @@map("users")
}

// ============================================
// LEADS (Clientes potenciales y actuales)
// ============================================

model Lead {
  id              String   @id @default(cuid())
  companyName     String
  contactName     String
  email           String
  phone           String?
  phoneCountryCode String?  // Código de país del teléfono (ej: "+34")
  jobTitle        String?  // Cargo del contacto principal
  country         String
  website         String?

  // Status: LEAD, PROSPECT, CLIENT, ARCHIVED
  status          String   @default("LEAD")

  // Commission Type: AGENCY_PARTNER, TECH_PARTNER, REFERRAL, CUSTOM
  commissionType  String   @default("REFERRAL")

  // Commission percentage (0.0 - 100.0)
  commissionRate  Float    @default(0.0)

  // Relaciones
  partnerId       String
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  createdById     String?
  createdBy       User?    @relation(fields: [createdById], references: [id])

  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  assignedAt      DateTime @default(now())
  convertedAt     DateTime? // Cuando pasa a CLIENT

  // Relaciones
  payments        Payment[]
  contacts        Contact[]
  leadNotes       LeadNote[]

  @@map("leads")
}

// ============================================
// LEAD NOTES (Historial de notas por lead)
// ============================================

model LeadNote {
  id        String   @id @default(cuid())

  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Quien creó la nota (puede ser null si fue el partner owner)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  // Si no hay userId, guardamos el partnerId
  partnerId String?

  // Nombre del autor (para mostrar aunque se elimine el usuario)
  authorName String

  content   String

  createdAt DateTime @default(now())

  @@map("lead_notes")
}

// ============================================
// CONTACTS (Personas de contacto por lead)
// ============================================

model Contact {
  id              String   @id @default(cuid())

  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  name            String
  email           String
  phone           String?
  phoneCountryCode String?  // Código de país del teléfono (ej: "+34")
  jobTitle        String?  // Cargo de la persona
  isPrimary       Boolean  @default(false)  // Contacto principal

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("contacts")
}

// ============================================
// PAYMENTS (Pagos de clientes)
// ============================================

model Payment {
  id                String   @id @default(cuid())

  leadId            String
  lead              Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  amount            Float
  currency          String   @default("EUR")
  paymentDate       DateTime

  // Status: PENDING, COMPLETED, FAILED
  status            String   @default("PENDING")

  // Comisión calculada automáticamente
  commissionAmount  Float

  // Referencia externa (de la intranet de Omniwallet)
  externalReference String?

  description       String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  invoices          InvoicePayment[]

  @@map("payments")
}

// ============================================
// INVOICES (Facturas de comisiones)
// ============================================

model Invoice {
  id            String   @id @default(cuid())

  partnerId     String
  partner       Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  invoiceNumber String   @unique

  // Periodo de facturación
  periodMonth   Int      // 1-12
  periodYear    Int      // 2024, 2025, etc.

  totalAmount   Float
  currency      String   @default("EUR")

  // Status: DRAFT, SENT, PAID
  status        String   @default("DRAFT")

  pdfUrl        String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  sentAt        DateTime?
  paidAt        DateTime?

  // Relaciones
  payments      InvoicePayment[]

  @@map("invoices")
}

// ============================================
// INVOICE_PAYMENT (Relación muchos a muchos)
// ============================================

model InvoicePayment {
  id         String   @id @default(cuid())

  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  paymentId  String
  payment    Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([invoiceId, paymentId])
  @@map("invoice_payments")
}

// ============================================
// CONTENT (Contenido del portal)
// ============================================

model Content {
  id          String   @id @default(cuid())

  title       String
  description String?

  // Type: DOCUMENT, VIDEO, GUIDE, CONTRACT, CERTIFICATION
  type        String

  // Category: COMMERCIAL, TECHNICAL, STRATEGIC, LEGAL, GENERAL
  category    String

  // URLs
  fileUrl     String?  // URL del archivo subido
  externalUrl String?  // URL externa (YouTube, etc.)
  coverImageUrl String?  // URL de la imagen de portada

  // Tags para búsqueda (JSON array)
  tags        String?

  // Metadata
  fileSize    Int?     // bytes
  mimeType    String?

  // Status: DRAFT, PUBLISHED
  status      String   @default("DRAFT")

  // Destacado en dashboard
  isFeatured  Boolean  @default(false)

  // Orden de visualización
  order       Int      @default(0)

  // Counters
  viewCount     Int    @default(0)
  downloadCount Int    @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  views       ContentView[]
  favorites   ContentFavorite[]

  @@map("contents")
}

// ============================================
// CONTENT VIEWS (Tracking de visualizaciones)
// ============================================

model ContentView {
  id         String   @id @default(cuid())

  contentId  String
  content    Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  downloaded Boolean  @default(false)
  viewedAt   DateTime @default(now())

  @@map("content_views")
}

// ============================================
// CONTENT FAVORITES (Favoritos de usuarios)
// ============================================

model ContentFavorite {
  id         String   @id @default(cuid())

  contentId  String
  content    Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([contentId, userId])
  @@map("content_favorites")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(cuid())

  // Puede ser para un User o un Partner
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  partnerId String?
  partner   Partner? @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // Type: PARTNER_REGISTERED, PARTNER_APPROVED, NEW_LEAD, LEAD_CONVERTED, NEW_PAYMENT, etc.
  type      String

  title     String
  message   String

  isRead    Boolean  @default(false)
  readAt    DateTime?

  // Datos adicionales en formato JSON
  metadata  String?

  createdAt DateTime @default(now())

  @@map("notifications")
}

// ============================================
// CERTIFICATION SYSTEM
// ============================================

model CertificationContent {
  id          String   @id @default(cuid())

  title       String
  content     String   // Markdown or rich text content
  description String?

  // Type: VIDEO, DOCUMENT, TEXT, EXTERNAL_LINK
  type        String

  // URL for videos or documents
  url         String?

  // Order for displaying content
  order       Int      @default(0)

  // Visibility
  isPublished Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("certification_contents")
}

model CertificationQuestion {
  id            String   @id @default(cuid())

  question      String

  // Options stored as JSON array: ["Option A", "Option B", "Option C", "Option D"]
  options       String

  // Correct answer index (0-based)
  correctAnswer Int

  // Optional explanation shown after answering
  explanation   String?

  // Order for displaying questions
  order         Int      @default(0)

  // Visibility
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("certification_questions")
}

model CertificationAttempt {
  id              String   @id @default(cuid())

  partnerId       String
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // Total questions in this attempt
  totalQuestions  Int

  // Correct answers
  correctAnswers  Int

  // Score percentage
  score           Float

  // Passed or failed (typically 70% or higher to pass)
  passed          Boolean

  // Answers stored as JSON: [{"questionId": "...", "answer": 0, "correct": true}, ...]
  answers         String

  completedAt     DateTime @default(now())

  @@map("certification_attempts")
}

// Configuración global del sello de certificación
model CertificationSettings {
  id                    String   @id @default(cuid())

  // URLs de las imágenes del sello
  badgeLightUrl         String?  // Versión clara del sello
  badgeDarkUrl          String?  // Versión oscura del sello

  // Textos configurables (pueden usar variables como {partnerName}, {expirationDate}, {score})
  badgeHoverText        String?  // Texto al hacer hover sobre el sello
  badgeAltText          String?  // Texto alternativo para accesibilidad

  // Configuración de validez
  validityMonths        Int      @default(12)  // Meses de validez de la certificación

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("certification_settings")
}

// ============================================
// WEBHOOK SUBSCRIPTIONS
// ============================================

model WebhookSubscription {
  id          String   @id @default(cuid())

  name        String   // Friendly name for the subscription
  url         String   // Webhook URL to send events to

  // Events this subscription listens to (JSON array of event types)
  // e.g., ["partner.registered", "lead.created", "lead.converted_to_client"]
  events      String

  // Secret key for webhook signature verification (optional)
  secret      String?

  // Status
  isActive    Boolean  @default(true)

  // Metadata
  description String?

  // Stats
  lastTriggeredAt DateTime?
  successCount    Int      @default(0)
  failureCount    Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Logs of webhook deliveries
  logs        WebhookLog[]

  @@map("webhook_subscriptions")
}

model WebhookLog {
  id              String   @id @default(cuid())

  subscriptionId  String
  subscription    WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  event           String   // Event type that was triggered
  payload         String   // JSON payload sent

  // Response info
  statusCode      Int?
  responseBody    String?
  responseTime    Int?     // milliseconds

  success         Boolean
  errorMessage    String?

  createdAt       DateTime @default(now())

  @@map("webhook_logs")
}
